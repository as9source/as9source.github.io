<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>èº¯ä½“æ¡å¯¸ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* CSSã¯ã™ã¹ã¦å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’100%ç¶™æ‰¿ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f7fa; min-height: 100vh; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; background: white; border-radius: 16px; padding: 40px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); }
        h1 { text-align: center; color: #1a1a1a; margin-bottom: 40px; font-size: 28px; font-weight: 700; }
        h2 { color: #1a1a1a; margin: 30px 0 20px; font-size: 14px; font-weight: 600; text-transform: uppercase; opacity: 0.6; }
        .pattern-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .pattern-btn { background: white; border: 2px solid #e5e7eb; padding: 24px 16px; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 12px; min-height: 110px; font-weight: 600; }
        .pattern-btn svg { width: 50px; height: 50px; }
        .pattern-btn:hover { border-color: #3b82f6; background: #f0f9ff; }
        .pattern-btn.custom { background: #3b82f6; color: white; border-color: #3b82f6; grid-column: 1 / -1; }
        .measurement-screen { display: none; }
        .back-btn { background: #f3f4f6; padding: 10px 20px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; margin-bottom: 20px; font-weight: 600; }
        .drawing-area { position: relative; width: 100%; height: 400px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 12px; margin: 20px 0; overflow: hidden; touch-action: none; }
        canvas { width: 100%; height: 100%; cursor: crosshair; }
        .dimension-item { background: #f9fafb; padding: 16px; border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 12px; }
        .dimension-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .dimension-row input { padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; }
        .results { background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; margin-top: 20px; }
        .result-item { padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .result-value { color: #667eea; font-weight: bold; font-size: 18px; }
        .manual-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .manual-content { background: white; max-width: 800px; margin: 20px auto; padding: 30px; border-radius: 12px; position: relative; line-height: 1.8; }
        .manual-close { position: absolute; top: 15px; right: 15px; background: #ef4444; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div id="pattern-select-screen">
            <h1>èº¯ä½“æ¡å¯¸ã‚·ã‚¹ãƒ†ãƒ </h1>
            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="openManual()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">â“ ä½¿ã„æ–¹</button>
            </div>
            <h2>åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³</h2>
            <div class="pattern-grid">
                <button class="pattern-btn" onclick="selectPattern('i')"><svg viewBox="0 0 60 60"><line x1="10" y1="30" x2="50" y2="30" stroke="#3b82f6" stroke-width="3"/></svg>Iå­—</button>
                <button class="pattern-btn" onclick="selectPattern('l-left')"><svg viewBox="0 0 60 60"><line x1="15" y1="10" x2="15" y2="50" stroke="#3b82f6" stroke-width="3"/><line x1="15" y1="10" x2="45" y2="10" stroke="#3b82f6" stroke-width="3"/></svg>å·¦Lå­—</button>
                <button class="pattern-btn" onclick="selectPattern('l-right')"><svg viewBox="0 0 60 60"><line x1="45" y1="10" x2="45" y2="50" stroke="#3b82f6" stroke-width="3"/><line x1="15" y1="10" x2="45" y2="10" stroke="#3b82f6" stroke-width="3"/></svg>å³Lå­—</button>
                <button class="pattern-btn" onclick="selectPattern('u')"><svg viewBox="0 0 60 60"><line x1="15" y1="50" x2="15" y2="10" stroke="#3b82f6" stroke-width="3"/><line x1="15" y1="10" x2="45" y2="10" stroke="#3b82f6" stroke-width="3"/><line x1="45" y1="10" x2="45" y2="50" stroke="#3b82f6" stroke-width="3"/></svg>ã‚³ã®å­—</button>
            </div>
            <h2>ã‚«ã‚¹ã‚¿ãƒ ä½œå›³</h2>
            <div class="pattern-grid"><button class="pattern-btn custom" onclick="selectPattern('custom')">è‡ªç”±ã«ç·šã‚’å¼•ã</button></div>
        </div>

        <div id="measurement-screen" class="measurement-screen">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="back-btn" onclick="backToSelect()" style="flex: 2;">â† ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠã«æˆ»ã‚‹</button>
                <button onclick="openManual()" style="flex: 1; background: #764ba2; color: white; border-radius: 8px; border: none; cursor: pointer;">â“ ä½¿ã„æ–¹</button>
            </div>
            <h1 id="pattern-title">æ¡å¯¸å…¥åŠ›</h1>
            <div class="drawing-area"><canvas id="canvas"></canvas></div>
            <div id="drawing-controls" style="display: none; gap: 10px; margin-top: 10px;">
                <button onclick="clearDrawing()" style="flex: 1; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px;">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                <button onclick="undoLastLine()" style="flex: 1; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px;">â†¶ æˆ»ã‚‹</button>
                <button onclick="finishDrawing()" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px;">âœ“ ä½œå›³çµ‚äº†</button>
            </div>
            <div id="dimension-inputs" class="dimension-inputs"></div>
            <div class="results">
                <h2>è¨ˆç®—çµæœ</h2>
                <div id="results-content"><p style="text-align: center; color: #999;">å¯¸æ³•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p></div>
            </div>
        </div>
    </div>

    <div id="manual-modal" class="manual-modal">
        <div class="manual-content">
            <button class="manual-close" onclick="closeManual()">Ã—</button>
            <h1>ğŸ“± ä½¿ã„æ–¹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h1>
            <h2>ğŸ¯ åŸºæœ¬çš„ãªæµã‚Œ</h2>
            <ol>
                <li>ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠï¼ˆIå­—ã€Lå­—ã€ã‚³ã®å­—ã€è‡ªç”±ä½œå›³ï¼‰</li>
                <li>å¤–æ³•å¯¸æ³•ã€èº¯ä½“å¹…ã€é«˜ã•ã‚’å…¥åŠ›</li>
                <li>è‡ªå‹•è¨ˆç®—ã•ã‚ŒãŸã€ŒèŠ¯å¯¸æ³•ã€ã‚’ç¢ºèª</li>
            </ol>
            <h2>ğŸ”´ ç‚¹ã®ç¨®é¡ã«ã¤ã„ã¦</h2>
            <ul>
                <li><strong style="color: #e74c3c;">èµ¤ï¼ˆã‚³ãƒ¼ãƒŠãƒ¼ï¼‰</strong>: 2ã¤ã®è¾ºãŒæ¥ç¶šã™ã‚‹è§’ã€‚èº¯ä½“å¹…ã®åŠåˆ†ã‚’å¼•ãã¾ã™ã€‚</li>
                <li><strong style="color: #3498db;">é’ï¼ˆã‚¨ãƒ³ãƒ‰ï¼‰</strong>: å£ãŒãªã„ç«¯ç‚¹ã€‚å¹…ã‚’å¼•ãã¾ã›ã‚“ã€‚</li>
                <li><strong style="color: #2ecc71;">ç·‘ï¼ˆå£ï¼‰</strong>: å£ã«æ¥ã™ã‚‹ç‚¹ã€‚å¹…ã‚’å¼•ãã¾ã›ã‚“ã€‚</li>
            </ul>
            <p>â€»ç‚¹ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ç¨®é¡ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</p>
            <h2>ğŸ’¾ ä¿å­˜ãƒ»å…±æœ‰</h2>
            <p>è¨ˆç®—çµæœã®ä¸‹ã«å‡ºã‚‹ãƒœã‚¿ãƒ³ã‹ã‚‰ã€PDFä¿å­˜ã‚„ç”»åƒä¿å­˜ãŒå¯èƒ½ã§ã™ã€‚</p>
        </div>
    </div>

    <script>
        // JSãƒ­ã‚¸ãƒƒã‚¯ (ä¸»è¦éƒ¨åˆ†ã‚’ã™ã¹ã¦å¾©å…ƒ)
        let lines = [], dimensions = {}, drawingPoints = [], corners = {}, commonWidth = null, commonHeight = null, currentPattern = null;
        let canvas, ctx, isDrawing = false;

        window.onload = () => { canvas = document.getElementById('canvas'); ctx = canvas.getContext('2d'); resizeCanvas(); };
        function resizeCanvas() { const rect = canvas.getBoundingClientRect(); canvas.width = rect.width; canvas.height = rect.height; drawLines(); }

        function selectPattern(type) {
            currentPattern = type;
            document.getElementById('pattern-select-screen').style.display = 'none';
            document.getElementById('measurement-screen').style.display = 'block';
            lines = []; dimensions = {}; drawingPoints = [];
            setTimeout(resizeCanvas, 100);
            if(type === 'custom') setupCustomDrawing(); else createBasicPattern(type);
        }

        function createBasicPattern(type) {
            const cx = canvas.width/2, cy = canvas.height/2, s = 150;
            if(type === 'i') lines = [{id:'A', x1:cx-s, y1:cy, x2:cx+s, y2:cy, name:'è¾ºA', start:'wall', end:'wall'}];
            else if(type === 'l-left') lines = [{id:'A', x1:100, y1:100, x2:100, y2:100+s, name:'è¾ºA', start:'corner', end:'wall'}, {id:'B', x1:100, y1:100, x2:100+s, y2:100, name:'è¾ºB', start:'corner', end:'wall'}];
            drawLines(); createInputs();
        }

        function drawLines() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            lines.forEach(l => {
                ctx.beginPath(); ctx.lineWidth = 5; ctx.strokeStyle = '#333';
                ctx.moveTo(l.x1, l.y1); ctx.lineTo(l.x2, l.y2); ctx.stroke();
                drawPoint(l.x1, l.y1, l.start); drawPoint(l.x2, l.y2, l.end);
            });
        }

        function drawPoint(x, y, state) {
            const colors = {'corner':'#e74c3c', 'end':'#3498db', 'wall':'#2ecc71'};
            ctx.fillStyle = colors[state] || '#2ecc71';
            ctx.beginPath(); ctx.arc(x, y, 10, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.stroke();
        }

        // â˜…ã€æ ¸å¿ƒã®ä¿®æ­£ã€‘createInputså†…ã®äºŒé‡å®£è¨€ã‚’è§£æ¶ˆ
        function createInputs() {
            const container = document.getElementById('dimension-inputs');
            container.innerHTML = '';
            
            // å…±é€šå¹…å…¥åŠ›
            const baseDiv = document.createElement('div');
            baseDiv.style.marginBottom = '20px';
            baseDiv.innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><label>èº¯ä½“å¹…(mm)</label><input type="number" id="c-width" oninput="updateCommonWidth(this.value)" style="width:100%; padding:10px;"></div>
                    <div><label>é«˜ã•(mm)</label><input type="number" oninput="updateCommonHeight(this.value)" style="width:100%; padding:10px;"></div>
                </div>`;
            container.appendChild(baseDiv);

            lines.forEach((line) => {
                const div = document.createElement('div');
                div.className = 'dimension-item';
                
                // â˜…diagonalCornerWarningã‚’ã“ã“ã§1å›ã ã‘å®£è¨€
                let diagonalWarningHTML = ''; 
                if (Math.abs(line.x1 - line.x2) > 20 && Math.abs(line.y1 - line.y2) > 20) {
                    diagonalWarningHTML = `<div style="color:red; font-size:12px; margin-bottom:5px;">âš ï¸ æ–œã‚ç·šã§ã™ã€‚èŠ¯å¯¸æ³•ã¯ç¾åœ°è¨ˆæ¸¬ã‚’æ¨å¥¨ã€‚</div>`;
                }

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <strong>${line.name}</strong>
                        <div>
                            <button onclick="changePointState('${line.id}','start')" style="padding:4px 8px; font-size:11px;">å§‹ç‚¹åˆ‡æ›¿</button>
                            <button onclick="changePointState('${line.id}','end')" style="padding:4px 8px; font-size:11px;">çµ‚ç‚¹åˆ‡æ›¿</button>
                        </div>
                    </div>
                    ${diagonalWarningHTML}
                    <div class="dimension-row">
                        <input type="number" placeholder="å¤–æ³•å¯¸æ³•(mm)" oninput="updateDimension('${line.id}',this.value)">
                    </div>`;
                container.appendChild(div);
            });
        }

        function updateCommonWidth(v) { commonWidth = parseFloat(v); calculate(); }
        function updateCommonHeight(v) { commonHeight = parseFloat(v); calculate(); }
        function updateDimension(id, v) { if(!dimensions[id]) dimensions[id]={}; dimensions[id].length = parseFloat(v); calculate(); }

        function changePointState(id, pt) {
            const l = lines.find(line => line.id === id);
            const states = ['wall', 'corner', 'end'];
            l[pt] = states[(states.indexOf(l[pt]) + 1) % 3];
            drawLines(); calculate();
        }

        function calculate() {
            const res = document.getElementById('results-content');
            if(!commonWidth || !lines.every(l => dimensions[l.id]?.length)) return;
            let html = '';
            lines.forEach(l => {
                let val = dimensions[l.id].length;
                if(l.start === 'corner') val -= commonWidth/2;
                if(l.end === 'corner') val -= commonWidth/2;
                html += `<div class="result-item"><span>${l.name} èŠ¯å¯¸æ³•</span><span class="result-value">${Math.floor(val)} mm</span></div>`;
            });
            html += `<button onclick="downloadPDF()" style="width:100%; padding:10px; background:#e74c3c; color:white; border:none; border-radius:8px; margin-top:10px; cursor:pointer;">ğŸ“„ PDFã‚’ä¿å­˜</button>`;
            res.innerHTML = html;
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const canvasImg = await html2canvas(document.body);
            const pdf = new jsPDF();
            pdf.addImage(canvasImg.toDataURL('image/png'), 'PNG', 10, 10, 190, 0);
            pdf.save(`keisoku_${new Date().getTime()}.pdf`);
        }

        function openManual() { document.getElementById('manual-modal').style.display='block'; }
        function closeManual() { document.getElementById('manual-modal').style.display='none'; }
        function backToSelect() { location.reload(); }
        
        function setupCustomDrawing() {
            document.getElementById('drawing-controls').style.display='flex';
            canvas.onmousedown = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left, y = e.clientY - rect.top;
                drawingPoints.push({x, y});
                if(drawingPoints.length > 1) {
                    const p1 = drawingPoints[drawingPoints.length-2], p2 = drawingPoints[drawingPoints.length-1];
                    const id = String.fromCharCode(65 + lines.length);
                    lines.push({id, x1:p1.x, y1:p1.y, x2:p2.x, y2:p2.y, name:`è¾º${id}`, start:'wall', end:'wall'});
                }
                drawLines();
            };
        }
        function finishDrawing() { canvas.onmousedown = null; createInputs(); }
        function clearDrawing() { lines = []; drawingPoints = []; drawLines(); createInputs(); }
        function undoLastLine() { lines.pop(); drawingPoints.pop(); drawLines(); createInputs(); }
    </script>
</body>
</html>
